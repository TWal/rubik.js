//License: https://github.com/TWal/rubik.js/blob/master/LICENSE

Rubikjs.Notation.Instruction=function(){};Rubikjs.Notation.Instruction.prototype.copy=function(){return new Rubikjs.Notation.Instruction};Rubikjs.Notation.Move=function(a,b){this.group=a;this.count=b};Rubikjs.Notation.Move.prototype=new Rubikjs.Notation.Instruction;Rubikjs.Notation.Move.prototype.constructor=new Rubikjs.Notation.Move;Rubikjs.Notation.Move.prototype.copy=function(){return new Rubikjs.Notation.Move(this.group,this.count)};
Rubikjs.Notation.MultiMove=function(a,b){this.moves=a;this.count=b};Rubikjs.Notation.MultiMove.prototype=new Rubikjs.Notation.Instruction;Rubikjs.Notation.MultiMove.prototype.constructor=new Rubikjs.Notation.MultiMove;Rubikjs.Notation.MultiMove.prototype.copy=function(){for(var a=[],b=0;b<this.moves.length;++b)a.push(this.moves[b].copy());return new Rubikjs.Notation.MultiMove(a,this.count)};
Rubikjs.Notation.Parser=function(){this.separator=" ";this.handleCommutators=this.handleCombined=this.handleParenthesis=!0};
Rubikjs.Notation.Parser.prototype.parse=function(a){Rubikjs.Core.Logger.log("Notation",'Parsing "'+a+'"',"info");var b=this,c=function(a){var d=b.roughSplit(a);if(d[0]==a){if("("==a[0])return d=a.lastIndexOf(")"),b.multiplyInstuctions(c(a.substring(1,d)),b.getCount(a.substring(d+1)));if("{"==a[0])return d=a.lastIndexOf("}"),[b.combineInstructions(c(a.substring(1,d)),b.getCount(a.substring(d+1)))];if("["==a[0]){var d=a.lastIndexOf("]"),f=b.findMatching(a,"[","]",","),g=b.findMatching(a,"[","]",":");
if(-1!=f)return b.multiplyInstuctions(b.commutateInstructions(c(a.substring(1,f)),c(a.substring(f+1,d))),b.getCount(a.substring(d+1)));if(-1!=g)return b.multiplyInstuctions(b.conjugateInstructions(c(a.substring(1,g)),c(a.substring(g+1,d))),b.getCount(a.substring(d+1)));Rubikjs.Core.Logger.log("Notation","No ',' or ':' between '[' and ']'","error");return[]}return b.simpleParse(d[0])}return d.map(c).reduce(function(a,b){return a.concat(b)},[])};return c(a)};
Rubikjs.Notation.Parser.prototype.simpleParse=function(a){a=a.split(this.separator);for(var b=[],c=0;c<a.length;++c)""!=a[c]&&b.push(this.parseToken(a[c]));return b};
Rubikjs.Notation.Parser.prototype.roughSplit=function(a){if(""==a)return[];if(this.handleParenthesis&&!this.occurencesEqual(a,"(",")"))return Rubikjs.Core.Logger.log("Notation","Unmatched '(' or ')'","error"),[];if(this.handleCombined&&!this.occurencesEqual(a,"{","}"))return Rubikjs.Core.Logger.log("Notation","Unmatched '{' or '}'","error"),[];if(this.handleCommutators&&!this.occurencesEqual(a,"[","]"))return Rubikjs.Core.Logger.log("Notation","Unmatched '[' or ']'","error"),[];if(this.handleParenthesis&&
"("==a[0]){var b=this.findMatching(a,"(",")"),b=a.indexOf(this.separator,b),b=-1!=b?b:a.length;return[a.substring(0,b)].concat(this.roughSplit(a.substring(b)))}if(this.handleCombined&&"{"==a[0])return b=this.findMatching(a,"{","}"),b=a.indexOf(this.separator,b),b=-1!=b?b:a.length,[a.substring(0,b)].concat(this.roughSplit(a.substring(b)));if(this.handleCommutators&&"["==a[0])return b=this.findMatching(a,"[","]"),b=a.indexOf(this.separator,b),b=-1!=b?b:a.length,[a.substring(0,b)].concat(this.roughSplit(a.substring(b)));
b=a.length;if(this.handleParenthesis){var c=a.indexOf("(");-1!=c&&c<b&&(b=c)}this.handleCombined&&(c=a.indexOf("{"),-1!=c&&c<b&&(b=c));this.handleCommutators&&(c=a.indexOf("["),-1!=c&&c<b&&(b=c));return[a.substring(0,b)].concat(this.roughSplit(a.substring(b)))};Rubikjs.Notation.Parser.prototype.findMatching=function(a,b,c,e){e=e||c;for(var d=0,f=1;;){++d;if(1==f&&a[d]==e)return d;a[d]==b?f+=1:a[d]==c&&(f-=1);if(d>=a.length)return-1}};
Rubikjs.Notation.Parser.prototype.occurencesEqual=function(a,b,c){for(var e=0,d=0,f=0;f<a.length;++f)a[f]==b?++e:a[f]==c&&++d;return e==d};Rubikjs.Notation.Parser.prototype.multiplyInstuctions=function(a,b){if(0>b){a.reverse();for(var c=0;c<a.length;++c)a[c].count=-a[c].count;b=-b}for(var e=[],c=0;c<b;++c)e=e.concat(a);return e};Rubikjs.Notation.Parser.prototype.combineInstructions=function(a,b){return new Rubikjs.Notation.MultiMove(a,b)};
Rubikjs.Notation.Parser.prototype.commutateInstructions=function(a,b){for(var c=a.concat(b),e=a.length;e--;){var d=a[e].copy();d.count=-d.count;c.push(d)}for(e=b.length;e--;)d=b[e].copy(),d.count=-d.count,c.push(d);return c};Rubikjs.Notation.Parser.prototype.conjugateInstructions=function(a,b){for(var c=a.concat(b),e=a.length;e--;){var d=a[e].copy();d.count=-d.count;c.push(d)}return c};
Rubikjs.Notation.Parser.prototype.groupNameLength=function(a,b){b=b||"0123456789'";for(var c=a.length;c--;)if(-1==b.indexOf(a[c]))return c+1;return 0};Rubikjs.Notation.Parser.prototype.getCount=function(a){if(""==a)return 1;if("'"==a)return-1;var b=parseInt(a);return b!=b?1:"'"==a[a.length-1]?-b:b};Rubikjs.Notation.Parser.prototype.parseToken=function(a){return new Rubikjs.Notation.Instruction};
