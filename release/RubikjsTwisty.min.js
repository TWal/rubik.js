//License: https://github.com/TWal/rubik.js/blob/master/LICENSE

Rubikjs.Twisty.FixedPiecePlace=function(){this.pieces={};this.groups={};this.fullRotations={};this.turnDegree=90;this.turnTime=0.5;this.stepNumber=10;this.instructionQueue=[];this.isProcessingQueue=!1;this.rendermgr=null};Rubikjs.Twisty.FixedPiecePlace.prototype.endInit=function(){var b=this,a;for(a in this.groups)this.groups[a]instanceof Rubikjs.Twisty.FixedPiecePlace.Group&&(this.groups[a].pieces=this.groups[a].pieces.map(function(a){return a.map(function(a){return b.pieces[a]})}));this.rendermgr.render()};
Rubikjs.Twisty.FixedPiecePlace.prototype.sendInstruction=function(b){this.instructionQueue.push(b);this.processQueue()};Rubikjs.Twisty.FixedPiecePlace.prototype.sendMultipleInstructions=function(b){this.instructionQueue=this.instructionQueue.concat(b);this.processQueue()};
Rubikjs.Twisty.FixedPiecePlace.prototype.processQueue=function(){if(!this.isProcessingQueue)if(0==this.instructionQueue.length)this.isProcessingQueue=!1;else{this.isProcessingQueue=!0;var b=this.instructionQueue[0],a=this;b instanceof Rubikjs.Notation.Move?this.multipleMove(this.stepNumber,[this.groups[b.groupName].getTurnFunction(b.count,this.stepNumber)],function(){a.instructionQueue.shift();a.isProcessingQueue=!1;a.processQueue()}):b instanceof Rubikjs.Notation.FullRotation&&this.multipleMove(this.stepNumber,
[this.fullRotations[b.rotName].getTurnFunction(b.count,this.stepNumber)],function(){a.instructionQueue.shift();a.isProcessingQueue=!1;a.processQueue()})}};Rubikjs.Twisty.FixedPiecePlace.prototype.multipleMove=function(b,a,d){var c=0,f=this,e=function(){c<b?(a.forEach(function(a){a.turnFunction()}),c+=1,setTimeout(e,1E3*(f.turnTime/b)),f.rendermgr.render()):(a.forEach(function(a){a.endFunction()}),d())};e()};
Rubikjs.Twisty.FixedPiecePlace.Group=function(b){this.twisty=b;this.pieces=[];this.rotationAxis=[0,1,0];this.rotationCenter=[0,0,0]};Rubikjs.Twisty.FixedPiecePlace.Group.prototype.cycle=function(b){for(var a=0;a<this.pieces.length;++a)for(var d=this.pieces[a].map(function(a){return a.movable}),c=this.pieces[a].length,f=b%c+c,e=0;e<c;++e)this.pieces[a][e].movable=d[(e+f)%c]};
Rubikjs.Twisty.FixedPiecePlace.Group.prototype.getTurnFunction=function(b,a){var b=-b,d=this.twisty.turnDegree*Math.PI/180*b/a,c=this,f=mat4.rotate(mat4.identity(),d,c.rotationAxis);return{turnFunction:function(){c.pieces.forEach(function(a){a.forEach(function(a){mat4.multiply(f,a.movable.mesh.transform,a.movable.mesh.transform)})})},endFunction:function(){c.cycle(b)}}};Rubikjs.Twisty.FixedPiecePlace.Combined=function(b,a){this.twisty=b;this.groups=a};
Rubikjs.Twisty.FixedPiecePlace.Combined.prototype.getTurnFunction=function(b,a){for(var d=[],c=0;c<this.groups.length;++c)d.push(this.twisty.groups[this.groups[c][0]].getTurnFunction(b*this.groups[c][1],a));return{turnFunction:function(){for(var a=0;a<d.length;++a)d[a].turnFunction()},endFunction:function(){for(var a=0;a<d.length;++a)d[a].endFunction()}}};
