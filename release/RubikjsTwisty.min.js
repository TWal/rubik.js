//License: https://github.com/TWal/rubik.js/blob/master/LICENSE

Rubikjs.Twisty.FixedPiecePlace=function(){this.pieces={};this.groups={};this.fullRotations={};this.turnDegree=90;this.turnTime=0.5;this.stepNumber=10;this.instructionQueue=[];this.isProcessingQueue=!1;this.rendermgr=null};Rubikjs.Twisty.FixedPiecePlace.prototype.endInit=function(){var a=this,b;for(b in this.groups)this.groups[b].pieces=this.groups[b].pieces.map(function(b){return b.map(function(b){return a.pieces[b]})});this.rendermgr.render()};
Rubikjs.Twisty.FixedPiecePlace.prototype.sendInstruction=function(a){this.instructionQueue.push(a);this.processQueue()};Rubikjs.Twisty.FixedPiecePlace.prototype.sendMultipleInstructions=function(a){this.instructionQueue=this.instructionQueue.concat(a);this.processQueue()};
Rubikjs.Twisty.FixedPiecePlace.prototype.processQueue=function(){if(!this.isProcessingQueue)if(0==this.instructionQueue.length)this.isProcessingQueue=!1;else{this.isProcessingQueue=!0;var a=this.instructionQueue[0],b=this;a instanceof Rubikjs.Notation.Move?this.multipleMove(this.stepNumber,[this.groups[a.groupName].getTurnFunction(a.count,this.stepNumber)],function(){b.instructionQueue.shift();b.isProcessingQueue=!1;b.processQueue()}):a instanceof Rubikjs.Notation.FullRotation&&this.multipleMove(this.stepNumber,
[this.fullRotations[a.rotName].getTurnFunction(a.count,this.stepNumber)],function(){b.instructionQueue.shift();b.isProcessingQueue=!1;b.processQueue()})}};Rubikjs.Twisty.FixedPiecePlace.prototype.multipleMove=function(a,b,e){var c=0,d=this,f=function(){c<a?(b.forEach(function(a){a.turnFunction()}),c+=1,setTimeout(f,1E3*(d.turnTime/a)),d.rendermgr.render()):(b.forEach(function(a){a.endFunction()}),e())};f()};
Rubikjs.Twisty.FixedPiecePlace.Group=function(a){this.twisty=a;this.pieces=[];this.rotationAxis=[0,1,0];this.rotationCenter=[0,0,0]};Rubikjs.Twisty.FixedPiecePlace.Group.prototype.cycle=function(a){for(var b=0;b<this.pieces.length;++b)for(var e=this.pieces[b].map(function(a){return a.movable}),c=this.pieces[b].length,d=a%c+c,f=0;f<c;++f)this.pieces[b][f].movable=e[(f+d)%c]};
Rubikjs.Twisty.FixedPiecePlace.Group.prototype.getTurnFunction=function(a,b){var a=-a,e=this.twisty.turnDegree*Math.PI/180*a/b,c=this,d=mat4.rotate(mat4.identity(),e,c.rotationAxis);return{turnFunction:function(){c.pieces.forEach(function(a){a.forEach(function(a){mat4.multiply(d,a.movable.mesh.transform,a.movable.mesh.transform)})})},endFunction:function(){c.cycle(a)}}};
Rubikjs.Twisty.FixedPiecePlace.FullRotation=function(a){this.twisty=a;this.groups=[];this.rotationAxis=[0,1,0];this.rotationCenter=[0,0,0]};Rubikjs.Twisty.FixedPiecePlace.FullRotation.prototype.cycle=function(a){for(var b=0;b<this.groups.length;++b){var e={},c;for(c in this.twisty.groups)this.twisty.groups.hasOwnProperty(c)&&(e[c]=this.twisty.groups[c].pieces);for(var d=this.groups[b].length,f=a%d+d,g=0;g<d;++g)this.twisty.groups[this.groups[b][g]].pieces=e[this.groups[b][(g+f)%d]]}};
Rubikjs.Twisty.FixedPiecePlace.FullRotation.prototype.getTurnFunction=function(a,b){var a=-a,e=this.twisty.turnDegree*Math.PI/180*a/b,c=this,d=mat4.rotate(mat4.identity(),e,c.rotationAxis);return{turnFunction:function(){for(var a in c.twisty.pieces)mat4.multiply(d,c.twisty.pieces[a].movable.mesh.transform,c.twisty.pieces[a].movable.mesh.transform)},endFunction:function(){c.cycle(a)}}};
